$(function(){
	var shw = window.shw || {};

	var TEXT_TITLE = "地点一覧";
	var TEXT_RETURN = "<i class='fa fa-reply'></i>";
	var TEXT_ACTION = "<i class='fa fa-plus'></i>";
	var TEXT_ACTADD = "地点を追加";
	var TEXT_ACTGOT = "目的地に設定";
	var TEXT_ACTREN = "名前を変更";
	var TEXT_ACTDEL = "削　除";
	var TEXT_ACTEXT = "キャンセル";
	var TEXT_PROMPT = "名前を入力してください";
	var TEXT_DUPLCATE = "同じ名前があります";
	var TEXT_EMPTY = "名前が空です";
	var TEXT_NOLIST = "地点が登録されていません";
	var pointList = {};
	
	pointList.getSelectedName = function(){
		return $('#SHW-PL-POINT').val();
	};
	pointList.refreshList = function(){
		var list = shw.common.bindValue.point_list;
		var visible = false;
		list.removeAll();
		shw.common.storageAccessor(function(json){
			json.points.forEach(function(point){
				list.push(point);
			});
			visible = (json.points.length <= 0) ? true : false;
		});
		$("#SHW-PL-NOLIST")[visible ? "show" : "hide"]();
	};
	
	//init
	shw.common.setShowAction("point_list", pointList.refreshList);
	shw.common.setHideAction("point_list", function(){});
	var header = $("#SHW-LIST h1");
	var leftButton = $("#SHW-PL-BTN-L button");
	var rightButton = $("#SHW-PL-BTN-R button");
	var actions = {
		set: {el: $("#SHW-PL-GOTHERE"), txt: TEXT_ACTGOT, func: function(){
			var name = pointList.getSelectedName(), point = {};
			shw.common.storageAccessor(function(json){
				var points = json.points.filter(function(point){
					return point.name != name ? true : false;
				});
				point = points[0];
			});
			shw.forecast.setGoal(point.name, point.coords);
			shw.common.popPage();
		}},
		ren: {el: $("#SHW-PL-RENAME"), txt: TEXT_ACTREN, func: function(){
			var org = pointList.getSelectedName();
			bootbox.prompt({
				title: TEXT_PROMPT, value: org,
				callback: function(name) {
					if (name === null){ return; }
					name = name.replace(/(^\s+|\s+)/g);
					var inValidMessage = shw.selectPoint.isValidName(name);
					if(!inValidMessage){
						shw.common.storageAccessor(function(json){
							json.points.forEach(function(point){
								if(point.name == org){ point.name = name; }
							});
						});
						pointList.refreshList();
					} else { bootbox.alert(inValidMessage); }
				},
			});
		}},
		del: {el: $("#SHW-PL-REMOVE"), txt: TEXT_ACTDEL, func: function(){
			var name = pointList.getSelectedName();
			shw.common.storageAccessor(function(json){
				json.points = json.points.filter(function(point){
					return point.name == name ? true : false;
				});
			});
			pointList.refreshList();
		}},
		ext: {el: $("#SHW-PL-CANCEL"), txt: TEXT_ACTEXT, func: function(){}},
	};
	$(header).html(TEXT_TITLE);
	$(leftButton).html(TEXT_RETURN);
	$(rightButton).html(TEXT_ACTION);
	$("#SHW-PL-NOLIST").html(TEXT_NOLIST);
	$(leftButton).on("click tap", function(){
		shw.common.popPage();
	});
	$(rightButton).on("click tap", function(){
		shw.common.pushPage("select_point");
	});
	Object.keys(actions).forEach(function(name){
		var action = actions[name];
		$(action.el).html(action.txt).on("click tap", function(){
			action.func();
			$("#SHW-PL-LIST a.list-group-item.active").removeClass("active");
		});
	});
	$("#SHW-PL-LIST").on("click tap", "a.list-group-item", function(){
		$(this).addClass("active");
		$('#SHW-PL-POINT').val($(this).text());
	})

	shw.pointList = pointList;
});


